# Window function tests

# Setup
statement ok
CREATE TABLE sales (id INTEGER, region TEXT, amount INTEGER);

statement ok
INSERT INTO sales VALUES
(1, 'North', 100),
(2, 'North', 150),
(3, 'South', 200),
(4, 'South', 120),
(5, 'South', 180),
(6, 'East', 90),
(7, 'East', 110);

# ROW_NUMBER
query II
SELECT id, ROW_NUMBER() OVER (ORDER BY id) as rn FROM sales ORDER BY id;
----
1
1
2
2
3
3
4
4
5
5
6
6
7
7

# ROW_NUMBER with PARTITION BY
query TII
SELECT region, id, ROW_NUMBER() OVER (PARTITION BY region ORDER BY id) as rn FROM sales ORDER BY region, id;
----
East
6
1
East
7
2
North
1
1
North
2
2
South
3
1
South
4
2
South
5
3

# NTILE with 3 buckets
query II
SELECT id, NTILE(3) OVER (ORDER BY id) as bucket FROM sales ORDER BY id;
----
1
1
2
1
3
1
4
2
5
2
6
3
7
3

# LAG
query II
SELECT id, LAG(amount) OVER (ORDER BY id) as prev_amt FROM sales ORDER BY id;
----
1
NULL
2
100
3
150
4
200
5
120
6
180
7
90

# LAG with offset and default
query II
SELECT id, LAG(amount, 1, 0) OVER (ORDER BY id) as prev_amt FROM sales ORDER BY id;
----
1
0
2
100
3
150
4
200
5
120
6
180
7
90

# LEAD
query II
SELECT id, LEAD(amount) OVER (ORDER BY id) as next_amt FROM sales ORDER BY id;
----
1
150
2
200
3
120
4
180
5
90
6
110
7
NULL

# SUM window function - running total
query II
SELECT id, SUM(amount) OVER (ORDER BY id) as running_total FROM sales ORDER BY id;
----
1
100
2
250
3
450
4
570
5
750
6
840
7
950

# SUM with PARTITION BY
query TII
SELECT region, id, SUM(amount) OVER (PARTITION BY region ORDER BY id) as running_total FROM sales ORDER BY region, id;
----
East
6
90
East
7
200
North
1
100
North
2
250
South
3
200
South
4
320
South
5
500

# MIN window function
query II
SELECT id, MIN(amount) OVER (ORDER BY id) as min_so_far FROM sales ORDER BY id;
----
1
100
2
100
3
100
4
100
5
100
6
90
7
90

# MAX window function
query II
SELECT id, MAX(amount) OVER (ORDER BY id) as max_so_far FROM sales ORDER BY id;
----
1
100
2
150
3
200
4
200
5
200
6
200
7
200

# Window with ROWS frame - sliding window of 3
query II
SELECT id, SUM(amount) OVER (ORDER BY id ROWS BETWEEN 1 PRECEDING AND 1 FOLLOWING) as sum3 FROM sales ORDER BY id;
----
1
250
2
450
3
470
4
500
5
390
6
380
7
200

# Multiple window functions
query III
SELECT id, ROW_NUMBER() OVER (ORDER BY id) as rn, SUM(amount) OVER (ORDER BY id) as running_total FROM sales ORDER BY id;
----
1
1
100
2
2
250
3
3
450
4
4
570
5
5
750
6
6
840
7
7
950

# FIRST_VALUE
query TII
SELECT region, id, FIRST_VALUE(amount) OVER (PARTITION BY region ORDER BY id) as first_amt FROM sales ORDER BY region, id;
----
East
6
90
East
7
90
North
1
100
North
2
100
South
3
200
South
4
200
South
5
200

# ROWS UNBOUNDED PRECEDING
query II
SELECT id, SUM(amount) OVER (ORDER BY id ROWS UNBOUNDED PRECEDING) as running_sum FROM sales ORDER BY id;
----
1
100
2
250
3
450
4
570
5
750
6
840
7
950
