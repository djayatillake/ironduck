# JOIN tests

# Setup
statement ok
CREATE TABLE customers (id INTEGER, name TEXT, city TEXT);

statement ok
INSERT INTO customers VALUES
(1, 'Alice', 'NYC'),
(2, 'Bob', 'LA'),
(3, 'Charlie', 'Chicago'),
(4, 'Diana', 'NYC');

statement ok
CREATE TABLE orders (id INTEGER, customer_id INTEGER, amount INTEGER);

statement ok
INSERT INTO orders VALUES
(101, 1, 100),
(102, 1, 200),
(103, 2, 150),
(104, 5, 300);

# INNER JOIN
query ITI
SELECT c.id, c.name, o.amount FROM customers c INNER JOIN orders o ON c.id = o.customer_id ORDER BY c.id, o.amount;
----
1
Alice
100
1
Alice
200
2
Bob
150


# CROSS JOIN
statement ok
CREATE TABLE colors (color TEXT);

statement ok
INSERT INTO colors VALUES ('red'), ('blue');

statement ok
CREATE TABLE sizes (size TEXT);

statement ok
INSERT INTO sizes VALUES ('S'), ('M'), ('L');

query TT
SELECT color, size FROM colors CROSS JOIN sizes ORDER BY color, size;
----
blue
L
blue
M
blue
S
red
L
red
M
red
S

# Implicit CROSS JOIN with comma
query TT
SELECT color, size FROM colors, sizes ORDER BY color, size;
----
blue
L
blue
M
blue
S
red
L
red
M
red
S

# Self JOIN
query TT
SELECT a.name, b.name FROM customers a, customers b WHERE a.city = b.city AND a.id < b.id ORDER BY a.name, b.name;
----
Alice
Diana

# Multiple JOINs
statement ok
CREATE TABLE products (id INTEGER, name TEXT);

statement ok
INSERT INTO products VALUES (1, 'Widget'), (2, 'Gadget');

statement ok
CREATE TABLE order_items (order_id INTEGER, product_id INTEGER, qty INTEGER);

statement ok
INSERT INTO order_items VALUES (101, 1, 2), (101, 2, 1), (102, 1, 3);

query TTII
SELECT c.name, p.name, oi.qty, o.amount FROM customers c JOIN orders o ON c.id = o.customer_id JOIN order_items oi ON o.id = oi.order_id JOIN products p ON oi.product_id = p.id ORDER BY c.name, p.name;
----
Alice
Gadget
1
100
Alice
Widget
2
100
Alice
Widget
3
200

# JOIN with aggregate
query TI
SELECT c.name, SUM(o.amount) as total FROM customers c JOIN orders o ON c.id = o.customer_id GROUP BY c.id, c.name ORDER BY c.name;
----
Alice
300
Bob
150

# JOIN with WHERE
query ITI
SELECT c.id, c.name, o.amount FROM customers c JOIN orders o ON c.id = o.customer_id WHERE o.amount > 100 ORDER BY c.id;
----
1
Alice
200
2
Bob
150

# Tables for additional join tests
statement ok
CREATE TABLE t1 (id INTEGER, val TEXT);

statement ok
INSERT INTO t1 VALUES (1, 'a'), (2, 'b');

statement ok
CREATE TABLE t2 (id INTEGER, val2 TEXT);

statement ok
INSERT INTO t2 VALUES (1, 'x'), (3, 'y');

# Explicit ON clause equivalent to USING
query ITT
SELECT t1.id, t1.val, t2.val2 FROM t1 JOIN t2 ON t1.id = t2.id ORDER BY t1.id;
----
1
a
x

# JOIN on expression
query TT
SELECT c1.name, c2.name FROM customers c1 JOIN customers c2 ON c1.city = c2.city AND c1.id != c2.id ORDER BY c1.name;
----
Alice
Diana
Diana
Alice

# Alternative: Find customers with orders using INNER JOIN
query IT
SELECT DISTINCT c.id, c.name FROM customers c INNER JOIN orders o ON c.id = o.customer_id ORDER BY c.id;
----
1
Alice
2
Bob

# Multiple conditions in JOIN
query ITI
SELECT c.id, c.name, o.amount FROM customers c JOIN orders o ON c.id = o.customer_id AND o.amount >= 150 ORDER BY c.id, o.amount;
----
1
Alice
200
2
Bob
150

# Additional JOIN tables
statement ok
CREATE TABLE left_t (id INTEGER, val TEXT);

statement ok
INSERT INTO left_t VALUES (1, 'a'), (2, 'b');

statement ok
CREATE TABLE right_t (id INTEGER, val TEXT);

statement ok
INSERT INTO right_t VALUES (2, 'x'), (3, 'y');

# INNER JOIN between left_t and right_t
query ITIT
SELECT l.id, l.val, r.id, r.val FROM left_t l INNER JOIN right_t r ON l.id = r.id ORDER BY l.id;
----
2
b
2
x

# Subquery in JOIN
query TI
SELECT c.name, sub.total_orders FROM customers c JOIN (SELECT customer_id, COUNT(*) as total_orders FROM orders GROUP BY customer_id) sub ON c.id = sub.customer_id ORDER BY c.name;
----
Alice
2
Bob
1
